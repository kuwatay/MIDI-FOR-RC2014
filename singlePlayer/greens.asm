; Z80 Assembly Program to send MIDI Note messages via ACIA at $A0

	IFDEF CPM
	ORG $100           ; Program starting address
	ENDIF

	IFDEF SCM
	ORG $8000           ; Program starting address
	ENDIF
; 定義
ACIA_CTRL   EQU 0xA0        ; ACIAのコントロールレジスタアドレス
ACIA_DATA   EQU 0xA1        ; ACIAのデータレジスタアドレス
MIDI_END    EQU 0xFF        ; MIDIテーブルの終了バイト
DELAY_CONSTANT EQU 0x2FF

; MIDIイベントテーブルの先頭アドレス
MIDI_EVENTS_TABLE_ADDR EQU MIDI_EVENTS_TABLE

START:
;    ; ACIAの初期化 (必要な場合)
;    LD A, 0x03             ; 9600ボー、8N1の設定 (適宜調整)
;    OUT (ACIA_CTRL), A

    ; メインループ
MAIN_LOOP:
    LD HL, MIDI_EVENTS_TABLE_ADDR  ; テーブルの先頭アドレスをHLにロード
NEXT_EVENT:
    LD A, (HL)                    ; 次のイベントを読み込む (イベントタイプ)
    CP MIDI_END                    ; 終了バイト (0xFF) かどうかチェック
    JP Z, END_PROGRAM              ; 終了ならプログラム終了

    CALL SEND_BYTE                 ; イベントタイプをACIAに送信
    INC HL                         ; 次のデータ (ノート番号)
    LD A, (HL)                     ; ノート番号を読み込む
    CALL SEND_BYTE                 ; ノート番号をACIAに送信
    INC HL                         ; 次のデータ (ベロシティ)
    LD A, (HL)                     ; ベロシティを読み込む
    CALL SEND_BYTE                 ; ベロシティをACIAに送信
    INC HL                         ; 次のデータ (デルタタイム)
    LD A, (HL)                     ; デルタタイムを読み込む
    CP 0
    JP Z,NO_DELAY
    CALL WAIT_DELTA                ; デルタタイムに基づいて待機
NO_DELAY:	
    INC HL                         ; 次のイベントに移動
    JP NEXT_EVENT                  ; 次のイベントへ

; ACIAに1バイトを送信するサブルーチン
SEND_BYTE:
    ; ACIAの送信バッファが空になるまで待つ
    PUSH AF
WAIT_ACIA:
    IN A, (ACIA_CTRL)
    BIT 1, A                       ; 送信バッファ空か確認
    JR Z, WAIT_ACIA                ; 空でなければループ
    POP AF
    OUT (ACIA_DATA), A             ; データをACIAに送信
    RET

; デルタタイムに基づいて待機するサブルーチン
WAIT_DELTA:
    ; デルタタイムに基づいて一定時間待機 (シンプルなループで待機)
WAIT_LOOP:
    DEC A                          ; デルタタイムをデクリメント
    JP Z, WAIT_DONE                ; ゼロになったら待機終了
;    NOP                            ; 小さな遅延を発生
    CALL DELAY
    JP WAIT_LOOP
WAIT_DONE:
    RET

; Delay routine (simple loop for demonstration)
DELAY:
    PUSH AF
    PUSH BC
    LD BC, DELAY_CONSTANT   ; Load BC with a large value
DELAY_LOOP:
    DEC BC          ; Decrement BC
    LD A, B         ; Check if BC reached 0
    OR C
    JR NZ, DELAY_LOOP ; If not zero, keep looping
    POP BC
    POP AF
    RET             ; Return from subroutine

; プログラム終了ラベル
END_PROGRAM:
    ; 必要に応じて終了処理
    RET
;    JP END_PROGRAM                 ; 無限ループで終了

; MIDIイベントテーブル (Greensleeves全体のMIDIイベントに基づく)
MIDI_EVENTS_TABLE:
;Header: {'format_type': 0, 'num_tracks': 1, 'division': 384}

;Track 1:
    DB 144, 38, 50, 0
    DB 128, 38, 0, 96
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 50, 50, 0
    DB 128, 50, 0, 96
    DB 144, 53, 50, 0
    DB 128, 53, 0, 96
    DB 144, 50, 50, 0
    DB 128, 50, 0, 96
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 38, 50, 0
    DB 128, 38, 0, 96
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 50, 50, 0
    DB 128, 50, 0, 96
    DB 144, 53, 50, 0
    DB 128, 53, 0, 96
    DB 144, 50, 50, 0
    DB 128, 50, 0, 96
    DB 144, 45, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 45, 0, 0
    DB 144, 38, 50, 0
    DB 144, 65, 50, 0
    DB 128, 65, 0, 96
    DB 128, 38, 0, 0
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 50, 50, 0
    DB 144, 67, 50, 0
    DB 128, 67, 0, 96
    DB 128, 50, 0, 0
    DB 144, 53, 50, 0
    DB 144, 69, 50, 0
    DB 128, 69, 0, 96
    DB 128, 53, 0, 0
    DB 144, 50, 50, 0
    DB 144, 70, 50, 48
    DB 128, 50, 0, 48
    DB 128, 70, 0, 0
    DB 144, 45, 50, 0
    DB 144, 69, 50, 0
    DB 128, 69, 0, 96
    DB 128, 45, 0, 0
    DB 144, 36, 50, 0
    DB 144, 67, 50, 0
    DB 128, 67, 0, 96
    DB 128, 36, 0, 0
    DB 144, 43, 50, 0
    DB 128, 43, 0, 96
    DB 144, 48, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 96
    DB 128, 48, 0, 0
    DB 144, 52, 50, 0
    DB 144, 60, 50, 0
    DB 128, 60, 0, 96
    DB 128, 52, 0, 0
    DB 144, 48, 50, 0
    DB 144, 62, 50, 48
    DB 128, 48, 0, 48
    DB 128, 62, 0, 0
    DB 144, 43, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 96
    DB 128, 43, 0, 0
    DB 144, 34, 50, 0
    DB 144, 65, 50, 0
    DB 128, 65, 0, 96
    DB 128, 34, 0, 0
    DB 144, 41, 50, 0
    DB 128, 41, 0, 96
    DB 144, 46, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 46, 0, 0
    DB 144, 50, 50, 0
    DB 144, 62, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 62, 0, 0
    DB 128, 50, 0, 0
    DB 144, 46, 50, 0
    DB 144, 61, 50, 48
    DB 128, 46, 0, 48
    DB 128, 61, 0, 0
    DB 144, 41, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 41, 0, 0
    DB 144, 33, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 96
    DB 128, 33, 0, 0
    DB 144, 40, 50, 0
    DB 128, 40, 0, 96
    DB 144, 45, 50, 0
    DB 144, 61, 50, 0
    DB 128, 61, 0, 96
    DB 128, 45, 0, 0
    DB 144, 49, 50, 0
    DB 144, 57, 50, 0
    DB 128, 57, 0, 96
    DB 128, 49, 0, 0
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 40, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 40, 0, 0
    DB 144, 38, 50, 0
    DB 144, 65, 50, 0
    DB 128, 65, 0, 96
    DB 128, 38, 0, 0
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 50, 50, 0
    DB 144, 67, 50, 0
    DB 128, 67, 0, 96
    DB 128, 50, 0, 0
    DB 144, 53, 50, 0
    DB 144, 69, 50, 0
    DB 128, 69, 0, 96
    DB 128, 53, 0, 0
    DB 144, 50, 50, 0
    DB 144, 70, 50, 48
    DB 128, 50, 0, 48
    DB 128, 70, 0, 0
    DB 144, 45, 50, 0
    DB 144, 69, 50, 0
    DB 128, 69, 0, 96
    DB 128, 45, 0, 0
    DB 144, 36, 50, 0
    DB 144, 67, 50, 0
    DB 128, 67, 0, 96
    DB 128, 36, 0, 0
    DB 144, 43, 50, 0
    DB 128, 43, 0, 96
    DB 144, 48, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 96
    DB 128, 48, 0, 0
    DB 144, 52, 50, 0
    DB 144, 60, 50, 0
    DB 128, 60, 0, 96
    DB 128, 52, 0, 0
    DB 144, 48, 50, 0
    DB 144, 62, 50, 48
    DB 128, 48, 0, 48
    DB 128, 62, 0, 0
    DB 144, 43, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 48
    DB 128, 43, 0, 48
    DB 144, 34, 50, 0
    DB 144, 65, 50, 0
    DB 128, 65, 0, 96
    DB 128, 34, 0, 0
    DB 144, 41, 50, 0
    DB 144, 64, 50, 48
    DB 128, 41, 0, 48
    DB 128, 64, 0, 0
    DB 144, 46, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 48
    DB 128, 46, 0, 48
    DB 144, 33, 50, 0
    DB 144, 61, 50, 0
    DB 128, 61, 0, 96
    DB 128, 33, 0, 0
    DB 144, 40, 50, 0
    DB 144, 59, 50, 48
    DB 128, 40, 0, 48
    DB 128, 59, 0, 0
    DB 144, 45, 50, 0
    DB 144, 61, 50, 0
    DB 128, 61, 0, 96
    DB 128, 45, 0, 0
    DB 144, 38, 50, 0
    DB 144, 62, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 62, 0, 0
    DB 128, 38, 0, 0
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 50, 50, 0
    DB 128, 50, 0, 96
    DB 144, 53, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 53, 0, 0
    DB 144, 74, 50, 96
    DB 128, 74, 0, 96
    DB 144, 50, 50, 0
    DB 144, 77, 50, 0
    DB 128, 77, 0, 96
    DB 128, 50, 0, 0
    DB 144, 57, 50, 0
    DB 128, 57, 0, 96
    DB 144, 62, 50, 0
    DB 144, 79, 50, 0
    DB 128, 79, 0, 96
    DB 128, 62, 0, 0
    DB 144, 65, 50, 0
    DB 144, 81, 50, 0
    DB 128, 81, 0, 96
    DB 128, 65, 0, 0
    DB 144, 62, 50, 0
    DB 144, 82, 50, 48
    DB 128, 62, 0, 48
    DB 128, 82, 0, 0
    DB 144, 57, 50, 0
    DB 144, 81, 50, 0
    DB 128, 81, 0, 96
    DB 128, 57, 0, 0
    DB 144, 48, 50, 0
    DB 144, 79, 50, 0
    DB 128, 79, 0, 96
    DB 128, 48, 0, 0
    DB 144, 55, 50, 0
    DB 128, 55, 0, 96
    DB 144, 60, 50, 0
    DB 144, 76, 50, 0
    DB 128, 76, 0, 96
    DB 128, 60, 0, 0
    DB 144, 64, 50, 0
    DB 144, 72, 50, 0
    DB 128, 72, 0, 96
    DB 128, 64, 0, 0
    DB 144, 60, 50, 0
    DB 144, 74, 50, 48
    DB 128, 60, 0, 48
    DB 128, 74, 0, 0
    DB 144, 55, 50, 0
    DB 144, 76, 50, 0
    DB 128, 76, 0, 96
    DB 128, 55, 0, 0
    DB 144, 46, 50, 0
    DB 144, 77, 50, 0
    DB 128, 77, 0, 96
    DB 128, 46, 0, 0
    DB 144, 53, 50, 0
    DB 128, 53, 0, 96
    DB 144, 58, 50, 0
    DB 144, 74, 50, 0
    DB 128, 74, 0, 96
    DB 128, 58, 0, 0
    DB 144, 62, 50, 0
    DB 144, 74, 50, 0
    DB 144, 74, 50, 0
    DB 128, 74, 0, 96
    DB 128, 74, 0, 0
    DB 128, 62, 0, 0
    DB 144, 58, 50, 0
    DB 144, 73, 50, 48
    DB 128, 58, 0, 48
    DB 128, 73, 0, 0
    DB 144, 53, 50, 0
    DB 144, 74, 50, 0
    DB 128, 74, 0, 96
    DB 128, 53, 0, 0
    DB 144, 45, 50, 0
    DB 144, 76, 50, 0
    DB 128, 76, 0, 96
    DB 128, 45, 0, 0
    DB 144, 52, 50, 0
    DB 128, 52, 0, 96
    DB 144, 57, 50, 0
    DB 144, 73, 50, 0
    DB 128, 73, 0, 96
    DB 128, 57, 0, 0
    DB 144, 61, 50, 0
    DB 144, 69, 50, 0
    DB 128, 69, 0, 96
    DB 128, 61, 0, 0
    DB 144, 57, 50, 0
    DB 128, 57, 0, 96
    DB 144, 52, 50, 0
    DB 144, 74, 50, 0
    DB 128, 74, 0, 96
    DB 128, 52, 0, 0
    DB 144, 50, 50, 0
    DB 144, 77, 50, 0
    DB 128, 77, 0, 96
    DB 128, 50, 0, 0
    DB 144, 57, 50, 0
    DB 128, 57, 0, 96
    DB 144, 62, 50, 0
    DB 144, 79, 50, 0
    DB 128, 79, 0, 96
    DB 128, 62, 0, 0
    DB 144, 65, 50, 0
    DB 144, 81, 50, 0
    DB 128, 81, 0, 96
    DB 128, 65, 0, 0
    DB 144, 62, 50, 0
    DB 144, 82, 50, 48
    DB 128, 62, 0, 48
    DB 128, 82, 0, 0
    DB 144, 57, 50, 0
    DB 144, 81, 50, 0
    DB 128, 81, 0, 96
    DB 128, 57, 0, 0
    DB 144, 48, 50, 0
    DB 144, 79, 50, 0
    DB 128, 79, 0, 96
    DB 128, 48, 0, 0
    DB 144, 55, 50, 0
    DB 128, 55, 0, 96
    DB 144, 60, 50, 0
    DB 144, 76, 50, 0
    DB 128, 76, 0, 96
    DB 128, 60, 0, 0
    DB 144, 64, 50, 0
    DB 144, 72, 50, 0
    DB 128, 72, 0, 96
    DB 128, 64, 0, 0
    DB 144, 60, 50, 0
    DB 144, 74, 50, 48
    DB 128, 60, 0, 48
    DB 128, 74, 0, 0
    DB 144, 55, 50, 0
    DB 144, 76, 50, 0
    DB 128, 76, 0, 48
    DB 128, 55, 0, 48
    DB 144, 46, 50, 0
    DB 144, 77, 50, 0
    DB 128, 77, 0, 96
    DB 128, 46, 0, 0
    DB 144, 53, 50, 0
    DB 144, 76, 50, 48
    DB 128, 53, 0, 48
    DB 128, 76, 0, 0
    DB 144, 58, 50, 0
    DB 144, 74, 50, 0
    DB 128, 74, 0, 48
    DB 128, 58, 0, 48
    DB 144, 45, 50, 0
    DB 144, 73, 50, 0
    DB 128, 73, 0, 96
    DB 128, 45, 0, 0
    DB 144, 52, 50, 0
    DB 144, 71, 50, 48
    DB 128, 52, 0, 48
    DB 128, 71, 0, 0
    DB 144, 57, 50, 0
    DB 144, 73, 50, 0
    DB 128, 73, 0, 96
    DB 128, 57, 0, 0
    DB 144, 50, 50, 0
    DB 144, 74, 50, 0
    DB 144, 74, 50, 0
    DB 128, 74, 0, 96
    DB 128, 74, 0, 0
    DB 128, 50, 0, 0
    DB 144, 57, 50, 0
    DB 128, 57, 0, 96
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 144, 65, 50, 0
    DB 144, 74, 50, 0
    DB 128, 74, 0, 96
    DB 128, 65, 0, 0
    DB 144, 41, 50, 192
    DB 144, 72, 50, 0
    DB 144, 69, 50, 0
    DB 128, 69, 0, 96
    DB 128, 72, 0, 0
    DB 128, 41, 0, 0
    DB 144, 48, 50, 0
    DB 128, 48, 0, 96
    DB 144, 53, 50, 0
    DB 128, 53, 0, 96
    DB 144, 57, 50, 0
    DB 144, 72, 50, 0
    DB 144, 69, 50, 0
    DB 128, 69, 0, 96
    DB 128, 72, 0, 0
    DB 128, 57, 0, 0
    DB 144, 53, 50, 0
    DB 144, 70, 50, 48
    DB 144, 67, 50, 0
    DB 128, 53, 0, 48
    DB 128, 67, 0, 0
    DB 128, 70, 0, 0
    DB 144, 48, 50, 0
    DB 144, 69, 50, 0
    DB 144, 65, 50, 0
    DB 128, 65, 0, 48
    DB 128, 69, 0, 0
    DB 128, 48, 0, 48
    DB 144, 36, 50, 0
    DB 144, 67, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 96
    DB 128, 67, 0, 0
    DB 128, 36, 0, 0
    DB 144, 43, 50, 0
    DB 128, 43, 0, 96
    DB 144, 48, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 96
    DB 128, 48, 0, 0
    DB 144, 52, 50, 0
    DB 144, 60, 50, 0
    DB 128, 60, 0, 96
    DB 128, 52, 0, 0
    DB 144, 48, 50, 0
    DB 144, 62, 50, 48
    DB 128, 48, 0, 48
    DB 128, 62, 0, 0
    DB 144, 43, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 48
    DB 128, 43, 0, 48
    DB 144, 38, 50, 0
    DB 144, 65, 50, 0
    DB 128, 65, 0, 96
    DB 128, 38, 0, 0
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 50, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 50, 0, 0
    DB 144, 53, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 53, 0, 0
    DB 144, 50, 50, 0
    DB 144, 61, 50, 48
    DB 128, 50, 0, 48
    DB 128, 61, 0, 0
    DB 144, 45, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 48
    DB 128, 45, 0, 48
    DB 144, 33, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 96
    DB 128, 33, 0, 0
    DB 144, 40, 50, 0
    DB 128, 40, 0, 96
    DB 144, 45, 50, 0
    DB 144, 61, 50, 0
    DB 128, 61, 0, 96
    DB 128, 45, 0, 0
    DB 144, 49, 50, 0
    DB 144, 57, 50, 0
    DB 128, 57, 0, 96
    DB 128, 49, 0, 0
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 40, 50, 0
    DB 128, 40, 0, 96
    DB 144, 41, 50, 0
    DB 144, 72, 50, 0
    DB 144, 69, 50, 0
    DB 128, 69, 0, 96
    DB 128, 72, 0, 0
    DB 128, 41, 0, 0
    DB 144, 48, 50, 0
    DB 128, 48, 0, 96
    DB 144, 53, 50, 0
    DB 128, 53, 0, 96
    DB 144, 57, 50, 0
    DB 144, 72, 50, 0
    DB 144, 69, 50, 0
    DB 128, 69, 0, 96
    DB 128, 72, 0, 0
    DB 128, 57, 0, 0
    DB 144, 53, 50, 0
    DB 144, 70, 50, 48
    DB 144, 67, 50, 0
    DB 128, 53, 0, 48
    DB 128, 67, 0, 0
    DB 128, 70, 0, 0
    DB 144, 48, 50, 0
    DB 144, 69, 50, 0
    DB 144, 65, 50, 0
    DB 128, 65, 0, 48
    DB 128, 69, 0, 0
    DB 128, 48, 0, 48
    DB 144, 36, 50, 0
    DB 144, 67, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 96
    DB 128, 67, 0, 0
    DB 128, 36, 0, 0
    DB 144, 43, 50, 0
    DB 128, 43, 0, 96
    DB 144, 48, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 96
    DB 128, 48, 0, 0
    DB 144, 52, 50, 0
    DB 144, 60, 50, 0
    DB 128, 60, 0, 96
    DB 128, 52, 0, 0
    DB 144, 48, 50, 0
    DB 144, 62, 50, 48
    DB 128, 48, 0, 48
    DB 128, 62, 0, 0
    DB 144, 43, 50, 0
    DB 144, 64, 50, 0
    DB 128, 64, 0, 48
    DB 128, 43, 0, 48
    DB 144, 34, 50, 0
    DB 144, 65, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 65, 0, 0
    DB 128, 34, 0, 0
    DB 144, 41, 50, 0
    DB 144, 64, 50, 48
    DB 128, 41, 0, 48
    DB 128, 64, 0, 0
    DB 144, 46, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 48
    DB 128, 46, 0, 48
    DB 144, 33, 50, 0
    DB 144, 61, 50, 0
    DB 144, 57, 50, 0
    DB 128, 57, 0, 48
    DB 128, 61, 0, 0
    DB 128, 33, 0, 48
    DB 144, 40, 50, 0
    DB 144, 59, 50, 48
    DB 128, 40, 0, 48
    DB 128, 59, 0, 0
    DB 144, 45, 50, 0
    DB 144, 61, 50, 0
    DB 128, 61, 0, 48
    DB 128, 45, 0, 48
    DB 144, 38, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 38, 0, 0
    DB 144, 45, 50, 0
    DB 128, 45, 0, 96
    DB 144, 50, 50, 0
    DB 128, 50, 0, 96
    DB 144, 53, 50, 0
    DB 144, 62, 50, 0
    DB 128, 62, 0, 96
    DB 128, 53, 0, 0

; 終了イベント
    DB 0xFF               ; テーブルの終わりを示す
