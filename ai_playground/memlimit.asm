    ORG 100H           ; プログラム開始アドレスを$100に設定

    ; BIOSの開始アドレスを取得
    LD   HL, 0006H     ; BIOSのジャンプテーブルがあるアドレス
    LD   E, (HL)       ; ジャンプ先アドレスの下位バイトを読み込み
    INC  HL
    LD   D, (HL)       ; ジャンプ先アドレスの上位バイトを読み込み

    ; BIOSの開始アドレスから1引いてTPAの上限を設定
    LD   HL, DE        ; DEに格納されたBIOS開始アドレスをHLにコピー
    DEC  HL            ; TPAの上限アドレスを計算 (BIOS開始 - 1)

    ; TPA上限アドレスを16進数で表示
    CALL PRINT_HEX     ; HLレジスタにある値を16進数で表示

END_PROGRAM:
    RET                ; プログラム終了

;---------------------------------------------------------
; サブルーチン：PRINT_HEX
; HLにある値を16進数4桁でコンソールに表示する
;---------------------------------------------------------
PRINT_HEX:
    PUSH HL            ; HLを保存

    ; 上位バイト（H）を16進数に変換して表示
    LD   A, H          ; HレジスタをAにコピー
    CALL PRINT_HEX_BYTE ; Aに格納された1バイトを16進数表示

    POP  HL            ; HLを復元
    ; 下位バイト（L）を16進数に変換して表示
    LD   A, L          ; LレジスタをAにコピー
    CALL PRINT_HEX_BYTE ; Aに格納された1バイトを16進数表示

    RET

;---------------------------------------------------------
; サブルーチン：PRINT_HEX_BYTE
; Aにある値を16進数2桁でコンソールに表示する
;---------------------------------------------------------
PRINT_HEX_BYTE:
    PUSH AF            ; Aレジスタを保存
 ;   PUSH BC            ; BCを保存

    ; 上位4ビットをシフトして取得
    RRA
    RRA
    RRA
    RRA
    AND  0FH           ; 下位4ビットを残す
	CALL PRINT_HEX_DIGIT ; 上位4ビットを表示

    ; 下位4ビットを取得
    POP  AF            ; Aレジスタを復元
    AND  0FH           ; 下位4ビットを残す
    CALL PRINT_HEX_DIGIT ; 下位4ビットを表示

;    POP  BC            ; BCを復元
    RET

;---------------------------------------------------------
; サブルーチン：PRINT_HEX_DIGIT
; Aレジスタの4ビットの値を16進数で表示
;---------------------------------------------------------
PRINT_HEX_DIGIT:
    ADD  A, 30H        ; 数値を文字コードに変換
    CP   3AH           ; 9を超えた場合、A～Fにする
    JR   C, OUTPUT_DIGIT
    ADD  A, 07H        ; A～Fを表示するために調整

OUTPUT_DIGIT:
  ;  PUSH AF            ; Aレジスタを保存
    LD   C, 02H        ; BDOS関数 0x02 (コンソール出力)
    LD   E, A          ; 出力する文字をEに格納
    CALL 5H            ; BDOS呼び出し
;    POP  AF            ; Aレジスタを復元
    RET
